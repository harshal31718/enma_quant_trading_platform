<!DOCTYPE html>
<html>

<head>
  <title>ENMA Dashboard</title>
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }

    #chart {
      width: 100%;
      height: 500px;
    }
  </style>
</head>

<body>
  <h2>BTC/USDT â€“ 15m (Binance Futures)</h2>
  <div id="chart"></div>
  <h2 style="margin-top:40px;">Equity Curve</h2>
  <div id="equity-chart" style="width:100%; height:400px;"></div>

  <script>
    window.addEventListener("load", () => {
      const container = document.getElementById("chart");

      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: 500,
        layout: {
          backgroundColor: "#ffffff",
          textColor: "#000",
        },
        timeScale: {
          timeVisible: true,
          secondsVisible: false,
        },
      });

      const candleSeries = chart.addCandlestickSeries();
      const volumeSeries = chart.addHistogramSeries({
        priceFormat: { type: "volume" },
        priceScaleId: "",
        scaleMargins: { top: 0.8, bottom: 0 },
      });

      fetch("/api/data/historical?symbol=BTC/USDT&limit=200")
        .then(res => res.json())
        .then(data => {
          const sorted = data.candles
            .map(c => ({
              time: Math.floor(new Date(c.timestamp).getTime() / 1000),
              open: Number(c.open),
              high: Number(c.high),
              low: Number(c.low),
              close: Number(c.close),
              volume: Number(c.volume),
            }))
            .sort((a, b) => a.time - b.time);

          candleSeries.setData(
            sorted.map(c => ({
              time: c.time,
              open: c.open,
              high: c.high,
              low: c.low,
              close: c.close,
            }))
          );

          volumeSeries.setData(
            sorted.map(c => ({
              time: c.time,
              value: c.volume,
              color: c.close >= c.open ? "#26a69a" : "#ef5350",
            }))
          );

          chart.timeScale().fitContent();
        });

      window.addEventListener("resize", () => {
        chart.resize(container.clientWidth, 500);
      });
    });
  </script>
  <script>
    const equityChart = LightweightCharts.createChart(
      document.getElementById("equity-chart"),
      {
        width: window.innerWidth - 40,
        height: 400,
        layout: { background: { color: "#ffffff" }, textColor: "#000" },
        grid: { vertLines: { visible: false }, horzLines: { visible: false } },
      }
    );

    const equitySeries = equityChart.addLineSeries({
      color: "#16a34a",
      lineWidth: 2,
    });

    fetch("/public/equity_curve.csv")
      .then(res => res.text())
      .then(text => {
        const rows = text.trim().split("\n").slice(1);

        const data = rows.map(row => {
          const [time, equity] = row.split(",");
          return {
            time: Math.floor(new Date(time).getTime() / 1000),
            value: parseFloat(equity),
          };
        });

        equitySeries.setData(data);
      });
  </script>

</body>

</html>